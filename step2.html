<h1>Step 2: Saving data to Deployd with AJAX</h1>

<p>Right now, the comment app isn't very useful, because any comments you add go away when you refresh the page, and other people can't see them. It would be much better if you could save the comments somewhere and load them along with the page. </p>

<p>Of course, JavaScript is a client-side language, so you can't just save data - you have to send it to a server. That's where Deployd comes in. </p>

<h2>Creating a Collection</h2>

<p>Go to the dashboard and add a new <strong>Collection</strong> resource. Name it <code>/comments</code>.</p>

<p><img src="step2img/screenshot01.png" alt="New resource" title="" /></p>

<p><img src="step2img/screenshot02.png" alt="Collection resource" title="" /></p>

<p>In order to use a collection, you have to define what its objects will look like. In this app, you have to a save a name and a comment, which are both text. </p>

<p>Drag a <strong>string</strong> onto the Properties panel, just like adding a resource. Call it <code>name</code>. Leave "Optional" unchecked.</p>

<p><img src="step2img/screenshot03.png" alt="Adding a property" title="" /></p>

<p>Do the same thing to add another string called <code>comment</code>. Notice that the grid on the bottom of the screen has updated to include those properties.</p>

<p><img src="step2img/screenshot04.png" alt="Final schema" title="" /></p>

<p>Click the "Add" button on the grid. Type in a name and comment, then click "done".</p>

<p><img src="step2img/screenshot05.png" alt="Adding data from the dashboard" title="" /></p>

<p>Now you have a working database for your app! </p>

<h2>Getting data from a Collection</h2>

<p>In <code>script.js</code>, add these two utility functions to the top of the script (before <code>$(document).ready</code>). Make sure to replace <code>[MYAPP]</code> with your actual app url:</p>

<pre><code>function url(path) {
  return 'http://[MYAPP].deploydapp.com' + path;
}

function showError(xhr) {
  alert(xhr.responseText);
}

$(document).ready(function() {

//...
</code></pre>

<p>Inside your <code>$(document).ready</code> callback, add a <code>loadComments()</code> function and call it when the page loads.</p>

<pre><code>//...

$(document).ready(function() {

  loadComments();

  //...

  function loadComments() {
    $.get(url('/comments'), function(result) { //Use jQuery AJAX to send a request to the server
      var result = result || []; //If it's null, replace with an empty array
      $('#comments').empty(); //Empty the collection
      result.forEach(function(comment) { //Loop through the result
        addComment(comment); //Add it to the array.
      });
    });
  }
});
</code></pre>

<p>Notice that you don't have to use a special SDK to retreive data from a Deployd server. This tutorial uses jQuery to make things simpler, but you can use a standard XMLHTTPRequest object in vanilla JavaScript with the same effect.</p>

<p>If you'd like, add a "Refresh" button to the app, too:</p>

<p><code>index.html</code>:</p>

<pre><code>&lt;!-- ... --&gt;
&lt;div id="comments"&gt;
&lt;/div&gt;

&lt;button id="refresh-btn"&gt;Refresh&lt;/button&gt;

&lt;form id="comment-form"&gt;
&lt;!-- ... --&gt;
</code></pre>

<p><code>script.js</code>:</p>

<pre><code>// ...

loadComments();
$('#refresh-btn').click(loadComments);

$('#comment-form').submit(function() {

// ...
</code></pre>

<p>Now test out the app by opening <code>index.html</code>. (You don't have to upload it to Deployd first, just run it from your filesystem) The app should now show the comment you entered in the Dashboard. </p>

<p><img src="step2img/screenshot06.png" alt="Working app" title="" /></p>

<h2>How it works</h2>

<p>To better understand what's going, open a REST or HTTP client. If you don't already have one, you can usually search your browser's add-on source for "REST Client". Send a request to:</p>

<pre><code>URL: http://[YOURAPP].deploydapp.com/comments
Method: GET
</code></pre>

<p>You should get a response such as:</p>

<pre><code>Status: 200 OK

[{"_id":"4f7dd6ea7696253010000077","name":"Bob","comment":"Hello, World!"}]
</code></pre>

<p>A Deployd collection is a REST API just like Facebook, Twitter, Foursquare, and others. The data is formatted with JSON, which is similar to a JavaScript object or array literal. When jQuery loads this object, it parses the JSON automatically and turns it into a Javascript object.</p>

<h2>Saving data</h2>

<p>Notice that any comments you add through the app's form are still gone when you refresh. Let's make the form save comments to the database. </p>

<p>Delete these lines from <code>script.js</code>:</p>

<pre><code>//Clear the form elements
$('#name').val('');
$('#comment').val('');

addComment({
  name: name,
  comment: comment
});
</code></pre>

<p>And replace them with: </p>

<pre><code>$.ajax(url('/comments'), {
  type: 'POST',
  contentType: 'application/json',
  data: JSON.stringify({
    name: name,
    comment: comment
  }),
  success: function(result) {
    addComment(result);

    $('#name').val('');
    $('#comment').val('');
  },
  error: showError
});
</code></pre>

<p>To save data to a Deployd collection, you send a <code>POST</code> request to the same URL. The request should be formatted in JSON; you can use the JSON.stringify() method to do that. The REST request looks something like this:</p>

<pre><code>URL: http://[YOURAPP].deploydapp.com/comments
Method: POST
Headers:
  Content-Type: application/json
Body: {"name": "Fred", "comment": "What's up?"}

Status: 200 OK
{"_id":"4f7dd6ea7696253010000077","name":"Fred","comment":"What's up?"}
</code></pre>

<p>If you load the page now, you should be able to submit a comment that appears even after you refresh.</p>

<p>This would be a good time to reupload your HTML and JavaScript to your Files resource so that the latest version is on the server.</p>

<p>Your <code>script.js</code> should look like this now:</p>

<pre><code>function url(path) {
  return 'http://[MYAPP].deploydapp.com' + path;
}

function showError(xhr) {
  alert(xhr.responseText);
}

$(document).ready(function() {

  loadComments();
  $('#refresh-btn').click(loadComments);

  $('#comment-form').submit(function() {
    //Get the data from the form
    var name = $('#name').val();
    var comment = $('#comment').val();

    $.ajax(url('/comments'), {
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        name: name,
        comment: comment
      }),
      success: function(result) {
        addComment(result);

        $('#name').val('');
        $('#comment').val('');
      },
      error: showError
    });

    return false;
  });

  function addComment(comment) {
    $('&lt;div class="comment"&gt;')
      .append('&lt;div class="author"&gt;Posted by: ' + comment.name + '&lt;/div&gt;')
      .append('&lt;p&gt;' + comment.comment + '&lt;/p&gt;')
      .appendTo('#comments')
    ;
  }

  function loadComments() {
    $.get(url('/comments'), function(result) { //Use jQuery AJAX to send a request to the server
      var result = result || []; //If it's null, replace with an empty array
      $('#comments').empty(); //Empty the collection
      result.forEach(function(comment) { //Loop through the result
        addComment(comment); //Add it to the array.
      });
    });
  }

});
</code></pre>
